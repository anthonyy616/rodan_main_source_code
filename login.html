<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Hairs By TKM</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f0f0f;
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-card {
            background-color: #1a1a1a;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 24rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
        }
        .input-field {
            background-color: #2a2a2a;
            color: #ffffff;
            border: 1px solid #4a4a4a;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            width: 100%;
        }
        .input-field:focus {
            outline: none;
            border-color: #a855f7; /* Purple border on focus */
        }
        .continue-btn {
            background-color: #ffffff;
            color: #000000;
            font-weight: 500;
            border-radius: 0.5rem;
            padding: 0.75rem;
            width: 100%;
        }
        .social-btn {
            background-color: #2a2a2a;
            color: #ffffff;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            width: 100%;
        }
        .badge {
            background-color: #000000;
            color: #ffffff;
            font-size: 0.6rem; /* Smaller as requested */
            padding: 0.2rem 0.4rem;
            border-radius: 9999px;
            margin-left: 0.5rem;
        }
        .separator {
            display: flex;
            align-items: center;
            color: #6b7280;
            font-size: 0.875rem;
            margin: 1rem 0;
        }
        .separator::before, .separator::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #4a4a4a;
        }
        .separator::before {
            margin-right: 0.5rem;
        }
        .separator::after {
            margin-left: 0.5rem;
        }
        .signup-link {
            color: #6b7280;
            font-size: 0.875rem;
        }
        .signup-link a {
            color: #a855f7;
            text-decoration: none;
        }
        #forgot-password-link, #back-to-login {
            color: #a855f7;
            text-decoration: none;
        }
        #status {
            background-color: #2a2a2a;
            color: #ffffff;
            border-radius: 0.5rem;
            padding: 0.75rem;
        }
    </style>
</head>
<body>
    <!-- Login Card -->
    <div class="login-card">
        <h2 class="text-2xl font-bold text-center mb-6">Sign in</h2>
        
        <form id="login-form" class="space-y-4">
            <div>
                <label for="login_id" class="block text-sm font-medium text-gray-400 mb-2">Email Address</label>
                <input type="text" id="login_id" required 
                       placeholder="Your email address"
                       class="input-field">
            </div>
            
            <div>
                <label for="password" class="block text-sm font-medium text-gray-400 mb-2">Password</label>
                <input type="password" id="password" required 
                       class="input-field">
            </div>
            
            <div class="flex items-center justify-between text-sm">
                <label class="flex items-center">
                    <input type="checkbox" id="remember-me" class="rounded border-gray-500 text-purple-600 focus:ring-purple-500">
                    <span class="ml-2 text-gray-400">Remember me</span>
                </label>
                
                <a href="#" id="forgot-password-link" class="text-purple-400 hover:text-purple-300">
                    Forgot password?
                </a>
            </div>
            
            <button type="submit" class="continue-btn">
                Continue
            </button>
        </form>

        <!-- Forgot Password Form -->
        <div id="forgot-password-form" class="space-y-4 hidden">
            <h3 class="text-xl font-bold text-center mb-4">Reset Password</h3>
            <p class="text-sm text-gray-400 text-center">Enter your email address and we'll send you a password reset link.</p>
            
            <div>
                <label for="reset-email" class="block text-sm font-medium text-gray-400 mb-2">Email Address</label>
                <input type="email" id="reset-email" required 
                       class="input-field">
            </div>
            
            <button id="reset-password" class="continue-btn">
                Send Reset Link
            </button>
            
            <div class="text-center">
                <a href="#" id="back-to-login" class="text-purple-400 hover:text-purple-300 text-sm">
                    ‚Üê Back to Login
                </a>
            </div>
        </div>
        
        <div class="separator">OR</div>
        
        <button class="social-btn mb-2 relative">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/Google_%22G%22_logo.svg/1024px-Google_%22G%22_logo.svg.png" alt="Google logo" class="w-5 h-5 mr-2">
            Continue with Google
            <span class="badge absolute right-2 top-1/2 transform -translate-y-1/2">Last used</span>
        </button>
        
        <button class="social-btn">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/fa/Apple_logo_black.svg/833px-Apple_logo_black.svg.png" alt="Apple logo" class="w-5 h-5 mr-2 invert">
            Continue with Apple
        </button>
        
        <p class="text-center signup-link mt-4">Don't have an account? <a href="signup.html">Sign up</a></p>
        
        <div id="status" class="mt-4 p-3 rounded-lg text-center hidden"></div>
    </div>

    <script>
        // Initialize Feather Icons
        feather.replace();

        // Initialize AOS
        if (typeof AOS !== 'undefined') {
            AOS.init({ duration: 800, easing: 'ease-in-out' });
        }

        // Supabase Configuration - USE YOUR ACTUAL CREDENTIALS
        const supabaseUrl = 'https://nkmxznymrpvgzlznprmu.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5rbXh6bnltcnB2Z3psem5wcm11Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MDkyMTcsImV4cCI6MjA3NTQ4NTIxN30.5ZUz6WaFL-GTr72PXuCvG-4Xq_rplKZ_E0y3iI2HLmQ';
        
        // Initialize Supabase client correctly
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey, {
            auth: {
                persistSession: true,
                autoRefreshToken: true,
                detectSessionInUrl: true
            }
        });

        // Login function
        async function loginUser(event) {
            event.preventDefault();
            
            const login_id = document.getElementById('login_id').value.trim();
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('remember-me').checked;
            const statusDiv = document.getElementById('status');

            // Show loading state
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Logging in...';
            submitBtn.disabled = true;

            try {
                // Sign in with email/password (Supabase doesn't support phone login directly)
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: login_id, // Only email login supported in signInWithPassword
                    password: password
                });

                if (error) {
                    throw new Error(error.message);
                }

                if (data.user) {
                    // Fetch user profile
                    const { data: profile, error: profileError } = await supabase
                        .from('profiles')
                        .select('*')
                        .eq('id', data.user.id)
                        .single();

                    // Store profile locally (even if there's an error fetching it)
                    if (!profileError && profile) {
                        localStorage.setItem('userProfile', JSON.stringify(profile));
                    }

                    // Store session preference
                    if (rememberMe) {
                        localStorage.setItem('rememberMe', 'true');
                    }

                    // Show success message
                    statusDiv.className = 'mt-4 p-3 rounded-lg text-center bg-green-100 text-green-700';
                    statusDiv.innerHTML = '<strong>Success!</strong> Logged in successfully. Redirecting...';
                    statusDiv.classList.remove('hidden');

                    // Redirect after success
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1000);
                }

            } catch (error) {
                statusDiv.className = 'mt-4 p-3 rounded-lg text-center bg-red-100 text-red-700';
                statusDiv.textContent = `Error: ${error.message}`;
                statusDiv.classList.remove('hidden');
            } finally {
                // Reset button state
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        // Password reset function
        async function resetPassword(event) {
            event.preventDefault();
            
            const resetEmail = document.getElementById('reset-email').value.trim();
            const statusDiv = document.getElementById('status');
            const resetBtn = document.getElementById('reset-password');

            // Show loading state
            const originalText = resetBtn.textContent;
            resetBtn.textContent = 'Sending...';
            resetBtn.disabled = true;

            try {
                const { error } = await supabase.auth.resetPasswordForEmail(resetEmail, {
                    redirectTo: `${window.location.origin}/reset-password.html`
                });

                if (error) {
                    throw new Error(error.message);
                }

                statusDiv.className = 'mt-4 p-3 rounded-lg text-center bg-green-100 text-green-700';
                statusDiv.textContent = 'Password reset link sent to your email!';
                statusDiv.classList.remove('hidden');

                // Switch back to login form after 3 seconds
                setTimeout(() => {
                    showLoginForm();
                }, 3000);

            } catch (error) {
                statusDiv.className = 'mt-4 p-3 rounded-lg text-center bg-red-100 text-red-700';
                statusDiv.textContent = `Error: ${error.message}`;
                statusDiv.classList.remove('hidden');
            } finally {
                resetBtn.textContent = originalText;
                resetBtn.disabled = false;
            }
        }

        // Form visibility functions
        function showForgotPasswordForm() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('forgot-password-form').classList.remove('hidden');
            document.getElementById('status').classList.add('hidden');
        }

        function showLoginForm() {
            document.getElementById('forgot-password-form').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('status').classList.add('hidden');
        }

        // Event listeners
        document.getElementById('login-form').addEventListener('submit', loginUser);
        document.getElementById('forgot-password-link').addEventListener('click', (e) => {
            e.preventDefault();
            showForgotPasswordForm();
        });
        document.getElementById('back-to-login').addEventListener('click', (e) => {
            e.preventDefault();
            showLoginForm();
        });
        document.getElementById('reset-password').addEventListener('click', resetPassword);

        // Check if user is already logged in
        supabase.auth.getSession().then(({ data: { session } }) => {
            if (session) {
                window.location.href = 'index.html';
            }
        });

        // Auth state listener
        supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN' && session) {
                console.log('User signed in:', session.user.email);
            } else if (event === 'SIGNED_OUT') {
                console.log('User signed out');
                localStorage.removeItem('userProfile');
            }
        });

        // OAuth Event Listeners for Google and Apple
        document.querySelectorAll('.social-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
            const provider = btn.querySelector('img[alt="Google logo"]') ? 'google' : 'apple';
            const { error } = await supabase.auth.signInWithOAuth({
            provider: provider,
            options: {
                redirectTo: window.location.origin + '/index.html'  // Redirect after auth
            }
            });
            if (error) {
            console.error('OAuth Error:', error.message);
            // Optional: Show error in #status div
            const statusDiv = document.getElementById('status');
            statusDiv.className = 'mt-4 p-3 rounded-lg text-center bg-red-100 text-red-700';
            statusDiv.textContent = `Error: ${error.message}`;
            statusDiv.classList.remove('hidden');
            }
        });
        });
    </script>
    <script src="auth.js" defer></script>
</body>

</html>
